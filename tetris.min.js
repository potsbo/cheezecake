var e=[[[0,0,0,0],[1,1,1,1]],[[0,0,0,0],[0,1,1,0],[0,1,1,0]],[[0,1,1,0],[1,1,0,0]],[[1,1,0,0],[0,1,1,0]],[[1,0,0,0],[1,1,1,0]],[[0,0,1,0],[1,1,1,0]],[[0,1,0,0],[1,1,1,0]]],g="red yellow magenta green blue orange cyan".split(" "),k=[],m=function(){function f(){this.b=[];this.h=[];this.A=0;this.x=3;this.y=0;this.F=!0;for(var a=0;a<e.length;a++){this.h[a]=100;for(var b=0;k[b]==a;)this.h[a]/=2,b++;for(;10>b;)k[b]==a&&(this.h[a]-=Math.floor(10-b^1.5)),b++;this.A+=this.h[a]}for(;!(this.id=Math.floor(Math.random()*
e.length),Math.floor(Math.random()*this.A)<this.h[this.id]););for(a=0;4>a;a++)for(this.b[a]=[],b=0;4>b;b++)this.b[a][b]=0,e[this.id][a]&&e[this.id][a][b]&&(this.b[a][b]=this.id+1);for(b=9;0<b;b--)k[b]=k[b-1];k[0]=this.id}var d=f.prototype;d.R=function(){return this.b};d.o=function(){var a=[];if(2>this.id)for(var b=0;4>b;++b){a[b]=[];for(var c=0;4>c;++c)a[b][c]=this.b[c][3-b]}else for(b=0;4>b;++b){a[b]=[];for(c=0;3>c;++c)a[b][c]=this.b[c][2-b];a[b][3]=0}return this.b=a};d.j=function(){var a=[];if(2>
this.id)for(var b=0;4>b;++b){a[b]=[];for(var c=0;4>c;++c)a[b][c]=this.b[-c+3][b]}else for(b=0;4>b;++b){a[b]=[];for(c=0;3>c;++c)a[b][c]=this.b[-c+2][b];a[b][3]=0}return this.b=a};d.reset=function(){this.x=3;for(var a=this.y=0;4>a;a++){this.b[a]=[];for(var b=0;4>b;b++)this.b[a][b]=0,e[this.id][a]&&e[this.id][a][b]&&(this.b[a][b]=this.id+1)}};return f}();var n=function(){function f(){this.G()}var d=f.prototype;d.G=function(){this.f=0;this.u=1E3;this.level=0;this.map=[];this.a=new m;this.C=0;this.l=!1;this.canvas=document.getElementById("field");this.c=this.canvas.getContext("2d");this.s={};for(var a=this.s.w=0;21>a;a++){this.map[a]=[];for(var b=0;10>b;b++)this.map[a][b]=0}window.localStorage&&window.localStorage.getItem("highscore")&&(this.s.w=window.localStorage.getItem("highscore"))};d.m=function(){this.c.clearRect(180,0,600,600);this.c.strokeStyle=
"black";this.c.strokeRect(180,0,300,600);this.c.strokeRect(0,0,180,200);for(var a=0;20>a;a++)for(var b=0;10>b;b++)this.v(b,a,this.map[a+1][b]);for(a=0;4>a;a++)for(b=0;4>b;b++)this.v(this.a.x+b,this.a.y+a-1,this.a.b[a][b]);this.c.font="bold 30px Century Gothic";this.c.fillStyle="black";this.c.fillText("LINE",530,100);this.c.fillText(this.C,680,100);this.c.fillText("SCORE",530,150);this.c.fillText(this.f,680,150);this.c.fillText("LEVEL",530,200);this.c.fillText(this.level,680,200);this.c.fillText("HIGH SCORE",
530,250);this.c.fillText(this.s.w,680,280)};d.P=function(){this.c.clearRect(0,0,180,180);for(var a=0;4>a;a++)for(var b=0;4>b;b++)this.L(this.i.x+b,this.i.y+a-1,this.i.b[a][b])};d.g=function(a,b){for(var c=this.a.x+a,d=this.a.y+b,f=this.a,l=0;4>l;l++)for(var h=0;4>h;h++)if(f.b[l][h]&&(21<=d+l||0>c+h||10<=c+h||this.map[d+l][c+h]))return!1;return!0};d.L=function(a,b,c){this.v(a-8,b+3,c)};d.v=function(a,b,c){c&&(this.c.fillStyle=g[c-1],this.c.fillRect(180+30*a,30*b,29,29),this.c.strokeRect(180+30*a,30*
b,29,29))};d.K=function(){for(var a=0,b=20;0<=b;b--){for(var c=!0,d=0;10>d;d++)if(0==this.map[b][d]){c=!1;break}if(c){for(c=b-1;0<=c;c--)for(d=0;10>d;d++)this.map[c+1][d]=this.map[c][d];b++;a++;this.C++}}switch(a){case 1:this.f+=40;break;case 2:this.f+=100;break;case 3:this.f+=300;break;case 4:this.f+=1200}};d.B=function(){this.a=new m;for(var a=0;4>a;a++)if(this.a.b[0][a]){this.g(0,1)&&this.a.y++;break}this.g(0,0)||(this.m(),this.l=!0,window.localStorage&&this.s.w<this.f&&window.localStorage.setItem("highscore",
this.f),confirm("GAME OVER\n restart?")&&this.H())};d.J=function(){this.g(0,1)?this.a.y++:this.D();this.m();if(!this.l){var a=this;setTimeout(function(){a.J()},this.u)}};d.D=function(){if(!this.l){for(var a=0;4>a;a++)for(var b=0;4>b;b++)this.a.b[a][b]&&(this.map[this.a.y+a][this.a.x+b]=this.a.b[a][b]);this.K();this.B();this.level=Math.floor(this.f/1E3);this.u=this.M()}};d.O=function(){if(this.a.F){this.a.F=!1;var a=this.a;this.a=this.i||new m;this.a.reset();this.i=a;this.i.reset();for(a=0;4>a;a++)if(this.a.b[0][a]){this.g(0,
1)&&this.a.y++;break}}this.P()};d.M=function(){return 1E3/(this.level+1)+100};d.I=function(){this.B();this.m();var a=this;setTimeout(function(){a.J()},this.u)};d.o=function(){this.a.o();this.g(0,0)||this.a.j()};d.j=function(){this.a.j();this.g(0,0)||this.a.o()};d.move=function(a,b){var c=a||0,d=b||0;this.g(c,d)&&(this.a.x+=c,this.a.y+=d)};d.N=function(){for(;this.g(0,1);)this.a.y++,this.f++;this.D()};d.H=function(){this.l&&(console.log("restarting"),this.G(),this.I())};return f}();
document.body.onkeydown=function(f){switch(f.keyCode){case 37:p.move(-1,0);break;case 39:p.move(1,0);break;case 40:p.move(0,1);break;case 38:p.j();break;case 81:p.o();break;case 74:p.j();break;case 32:p.N();break;case 80:alert("pause");break;case 79:p.O();break;case 78:p.H()}p.m()};var p=new n;p.I();
