var e=[[[0,0,0,0],[1,1,1,1]],[[0,0,0,0],[0,1,1,0],[0,1,1,0]],[[0,1,1,0],[1,1,0,0]],[[1,1,0,0],[0,1,1,0]],[[1,0,0,0],[1,1,1,0]],[[0,0,1,0],[1,1,1,0]],[[0,1,0,0],[1,1,1,0]]],f="red yellow magenta green blue orange cyan".split(" "),g=[];
function h(){for(var a=[],c=0,b=0;b<e.length;b++)a[b]=1E3,g[0]==b&&(a[b]=1),c+=a[b];for(;!(b=Math.floor(Math.random()*e.length),console.log(b),Math.floor(Math.random()*c)<a[b]););for(a=9;0<a;a--)g[a]=g[a-1];g[0]=b;a=[];for(c=0;4>c;c++){a[c]=[];for(var d=0;4>d;d++)a[c][d]=0,e[b][c]&&e[b][c][d]&&(a[c][d]=b+1)}return a}
function k(a){var c=[],b;a:{for(b=0;4>b;b++)if(a[b])for(var d=0;4>d;d++)if(0!==a[b][d]){b=a[b][d];break a}b=void 0}if(2>=b)for(b=0;4>b;++b)for(c[b]=[],d=0;4>d;++d)c[b][d]=a[d][-b+3];else for(b=0;4>b;++b)for(c[b]=[],d=0;4>d;++d)c[b][d]=a[d][-b+2];return c};for(var l=document.getElementById("field").getContext("2d"),m=3,p=0,q,r=[],t=0,u=0,v=1E3,w=0,x,y=0;21>y;y++){r[y]=[];for(var z=0;10>z;z++)r[y][z]=0}q=h();A();B();
function A(){l.clearRect(0,0,600,600);l.strokeStyle="black";l.strokeRect(0,0,300,600);for(var a=0;20>a;a++)for(var c=0;10>c;c++)C(c,a,r[a+1][c]);for(a=0;4>a;a++)for(c=0;4>c;c++)C(m+c,p+a-1,q[a][c]);l.font="bold 30px Century Gothic";l.fillStyle="black";l.fillText("LINE",350,100);l.fillText(t,500,100);l.font="bold 30px Century Gothic";l.fillText("SCORE",350,150);l.fillText(u,500,150);l.font="bold 30px Century Gothic";l.fillText("LEVEL",350,200);l.fillText(w,500,200)}
function C(a,c,b){b&&(l.fillStyle=f[b-1],l.fillRect(30*a,30*c,29,29),l.strokeRect(30*a,30*c,29,29))}function B(){D(0,1)?p++:(E(),F(),w=Math.floor(u/1E3),v=1E3-200*w,q=h(),m=3,p=0,D(0,0)||(A(),x=1,alert("Game Over")));A();x||setTimeout(function(){B()},v)}function E(){for(var a=0;4>a;a++)for(var c=0;4>c;c++)q[a][c]&&(r[p+a][m+c]=q[a][c])}function D(a,c,b){a=m+a;c=p+c;b=b||q;for(var d=0;4>d;d++)for(var n=0;4>n;n++)if(b[d][n]&&(21<=c+d||0>a+n||10<=a+n||r[c+d][a+n]))return!1;return!0}
document.body.onkeydown=function(a){switch(a.keyCode){case 37:D(-1,0)&&m--;break;case 39:D(1,0)&&m++;break;case 40:D(0,1)&&p++;break;case 38:rotated=k(k(k(q)));D(0,0,rotated)&&(q=rotated);break;case 32:for(;D(0,1);)p++,u++;E();break;case 80:alert("pause")}A()};
function F(){for(var a=0,c=20;0<=c;c--){for(var b=!0,d=0;10>d;d++)if(0==r[c][d]){b=!1;break}if(b){for(b=c-1;0<=b;b--)for(d=0;10>d;d++)r[b+1][d]=r[b][d];c++;a++;t++}}switch(a){case 1:u+=40;break;case 2:u+=100;break;case 3:u+=300;break;case 4:u+=1200}};
